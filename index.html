<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YouTube LiveChat Redirect // AppleSang</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: #f9f9f9;
      font-family: sans-serif;
    }
    #msg-container {
      display: inline-block;
      padding: 20px;
      border-radius: 60px 0 60px 0;
      max-width: 80%;
      text-align: center;
      background-size: cover;
      background-position: center;
    }
    #msg {
      font-size: 2rem;
      font-weight: bold;
      color: #000;
      margin: 0;
    }
    .example {
      font-size: 1rem;
      color: black;
      margin-top: 10px;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.5s ease, opacity 0.5s ease;
    }
    .example.show {
      max-height: 2em;
      opacity: 1;
      color: black;
    }
  </style>
</head>
<body>
  <div id="msg-container">
    <div id="msg"></div>
    <!-- Example only on error -->
  </div>
  <script>
    const urlParams = new URLSearchParams(location.search);
    let identifier = urlParams.get('id');
    const intervalSec = 5;
    const proxy = "https://api.codetabs.com/v1/proxy?quest=";
    const backgrounds = [
      "https://raw.githubusercontent.com/AppleSang/LumboChat-CSS-Youtube/refs/heads/main/asset/Crimson.webp",
      "https://raw.githubusercontent.com/AppleSang/LumboChat-CSS-Youtube/refs/heads/main/asset/Jade.webp",
      "https://raw.githubusercontent.com/AppleSang/LumboChat-CSS-Youtube/refs/heads/main/asset/Honey.webp",
      "https://raw.githubusercontent.com/AppleSang/LumboChat-CSS-Youtube/refs/heads/main/asset/Sunset.webp"
    ];

    // Translation strings
    const translations = {
      en: {
        missingId: '‚ùå Type Your <a href="https://www.youtube.com/account_advanced" target="_blank">Channel ID</a> Or <a href="https://abc.net" target="_blank">@yourchannel</a>',
        findingChannel: 'üîç Finding Your Channel...',
        cannotFind: id => `‚ùå Cant Found Channel With '${id}'. Please re-check!`,
        gettingCode: 'üü° Getting Livestream Code...',
        streamNotFound: sec => `üëÄ Stream not found, retrying in ${sec} seconds...`,
        retrying: 'üîÅ Retrying...'
      },
      vi: {
        missingId: '‚ùå Nh·∫≠p <a href="https://www.youtube.com/account_advanced" target="_blank">Channel ID</a> ho·∫∑c <a href="https://abc.net" target="_blank">@t√™nk√™nhc·ªßab·∫°n</a> V√†o URL',
        findingChannel: 'üîç ƒêang t√¨m k√™nh c·ªßa b·∫°n...',
        cannotFind: id => `‚ùå Kh√¥ng t√¨m th·∫•y k√™nh v·ªõi '${id}'. Vui l√≤ng ki·ªÉm tra l·∫°i!`,
        gettingCode: 'üü° ƒêang l·∫•y m√£ Livestream...',
        streamNotFound: sec => `üëÄ Kh√¥ng t√¨m th·∫•y stream, s·∫Ω th·ª≠ l·∫°i sau ${sec} gi√¢y...`,
        retrying: 'üîÅ ƒêang th·ª≠ l·∫°i...'
      }
    };

    let lang = 'en';
    const msgEl = document.getElementById('msg');

    function setRandomBackground(container) {
      const bg = backgrounds[Math.floor(Math.random() * backgrounds.length)];
      container.style.backgroundImage = `url('${bg}')`;
    }

    function showMsg(textHtml) {
      const container = document.getElementById('msg-container');
      msgEl.innerHTML = textHtml;
      setRandomBackground(container);
    }

    function showErrorExampleLoop(container) {
      const example = document.createElement('div');
      example.className = 'example';
      container.appendChild(example);
      const texts = [
        'V√≠ d·ª•: https://applesang.github.io/yt-chat-fetcher/?id=UCEcZC1dyDrhWueALsmutdHA',
        'V√≠ d·ª•: https://applesang.github.io/yt-chat-fetcher/?id=NotRealSang | Ho·∫∑c | https://applesang.github.io/yt-chat-fetcher/?id=@NotRealSang'
      ];
      let index = 0;
      function cycle() {
        example.textContent = texts[index];
        example.classList.add('show');
        setTimeout(() => example.classList.remove('show'), 4000);
        setTimeout(() => { index = (index + 1) % texts.length; cycle(); }, 5000);
      }
      setTimeout(cycle, 50);
    }

    async function detectLanguage() {
      try {
        const res = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        if (data.country_code === 'VN') lang = 'vi';
      } catch (e) {
        console.warn('Language detection failed, default to English');
      }
    }

    // Strip leading '@'
    if (identifier && identifier.startsWith('@')) identifier = identifier.substring(1);

    (async function init() {
      await detectLanguage();
      const container = document.getElementById('msg-container');
      setRandomBackground(container);

      if (!identifier) {
        showMsg(translations[lang].missingId);
        showErrorExampleLoop(container);
        throw new Error("Missing 'id' parameter");
      }

      start();
    })();

    async function resolveChannelId(id) {
      if (/^UC[0-9A-Za-z_-]{22}$/.test(id)) return id;
      const urls = [
        "https://www.youtube.com/user/"+id,
        "https://www.youtube.com/c/"+id
      ];
      for (const url of urls) {
        try {
          const res = await fetch(proxy + encodeURIComponent(url));
          const html = await res.text();
          const match = html.match(/rel=\"canonical\" href=\"https:\/\/www\.youtube\.com\/channel\/(UC[\w-]{22})\"/);
          if (match) return match[1];
        } catch(e){}
      }
      return null;
    }

    async function checkLive(channelId) {
      try {
        const res = await fetch(proxy + encodeURIComponent(`https://www.youtube.com/channel/${channelId}/live`));
        const html = await res.text();
        if (html.includes('"isLiveContent":true')) {
          const m = html.match(/"videoId":"([\w-]{11})"/);
          if (m) return m[1];
        }
      } catch(e){}
      return null;
    }

    function startCountdown(chId, sec) {
      let s = sec;
      showMsg(translations[lang].streamNotFound(s));
      const t = setInterval(async ()=>{
        s--;
        if (s>0) showMsg(translations[lang].streamNotFound(s));
        else {
          clearInterval(t);
          showMsg(translations[lang].retrying);
          const vid = await checkLive(chId);
          vid? window.location.href = `https://www.youtube.com/live_chat?is_popout=1&v=${vid}` : startCountdown(chId, intervalSec);
        }
      },1000);
    }

    async function start() {
      showMsg(translations[lang].findingChannel);
      const chId = await resolveChannelId(identifier);
      if (!chId) {
        showMsg(translations[lang].cannotFind(identifier));
        return;
      }
      showMsg(translations[lang].gettingCode);
      const vid = await checkLive(chId);
      vid? window.location.href = `https://www.youtube.com/live_chat?is_popout=1&v=${vid}` : startCountdown(chId, intervalSec);
    }
  </script>
</body>
</html>
